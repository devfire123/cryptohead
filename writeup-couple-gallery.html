<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Couple Gallery (Android) | Axiom Vale</title>
    <meta
      name="description"
      content="Eschaton CTF 2026 Quals writeup: Couple Gallery (Android)."
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@400;500;600;700&family=IBM+Plex+Mono:wght@300;400;500&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="page">
      <header class="site-header">
        <div class="logo">Axiom Vale</div>
        <nav class="nav-links">
          <a href="index.html">Home</a>
          <a href="writeups.html">Writeups</a>
          <a href="blog.html">Blog</a>
          <a href="experience.html">Experience</a>
          <a href="projects.html">Projects</a>
          <a href="contact.html">Contact</a>
        </nav>
        <div class="badge">Crypto + Misc CTF</div>
      </header>

      <main>
        <section class="writeup-hero">
          <div>
            <p class="eyebrow">Eschaton CTF 2026 Quals</p>
            <h1>Couple Gallery (Android)</h1>
            <p class="lede">
              Hermes bytecode reverse + AES key extraction to decrypt images from a bundled
              SQLite DB.
            </p>
          </div>
          <div class="writeup-meta">
            <span class="tag">misc</span>
            <span class="tag">android</span>
          </div>
        </section>

        <section class="prose-card">
          <div class="prose">
            <h3>Overview</h3>
            <p>
              This APK is a React Native "secure gallery." Images are encrypted and stored
              inside a bundled SQLite DB. The app asks for a 6-digit PIN, but the PIN is only a
              UI gate. The actual decryption key is hardcoded in the Hermes bytecode. By
              extracting the key and decrypting DB rows, the images can be reconstructed. The
              images + constants together reveal all flag parts.
            </p>

            <h3>Recon</h3>
            <ul>
              <li>file: com.mcsc.couplegallery.apk</li>
              <li>arch: Android APK (React Native, Hermes bytecode)</li>
              <li>protections: none (no key obfuscation, no hardware binding, assets readable)</li>
              <li>Hermes bundle: assets/index.android.bundle</li>
              <li>Encrypted DB: res/raw/assets_gallery_secure.db</li>
              <li>Table: images(id INTEGER PRIMARY KEY, encrypted_data TEXT)</li>
              <li>Ciphertext strings start with U2FsdGVkX1 -> CryptoJS/OpenSSL "Salted__" base64</li>
            </ul>

            <h3>Vulnerability</h3>
            <p>
              Client-side secrets. The AES key is hardcoded in the Hermes bundle. The PIN is
              only used for keypad validation, not for encryption/decryption. This allows
              offline decryption of the DB without running the app.
            </p>

            <h3>Constraints / Gotchas</h3>
            <ul>
              <li>Hermes bytecode is not readable JS; disassemble to recover strings/logic.</li>
              <li>The ciphertext is base64 OpenSSL format, not raw bytes.</li>
              <li>Decrypted plaintext is NOT a PNG file directly; it is VALID_IMG_PREFIX + base64(PNG).</li>
              <li>The PIN is a red herring for cryptography; it gates the UI only.</li>
            </ul>

            <h3>Exploit Plan</h3>
            <ol>
              <li>Decompile APK to inspect assets and raw resources.</li>
              <li>Locate the bundled DB and confirm encrypted entries.</li>
              <li>Disassemble Hermes bundle and recover constants (AES key + PIN).</li>
              <li>Decrypt DB entries with AES key, strip prefix, decode base64 to PNG.</li>
              <li>Inspect images and assemble the flag.</li>
            </ol>

            <h3>Payload Layout</h3>
            <ul>
              <li>offset A: encrypted_data TEXT (OpenSSL "Salted__" base64)</li>
              <li>offset B: plaintext UTF-8 = VALID_IMG_PREFIX + base64(PNG)</li>
              <li>offset C: PNG image</li>
            </ul>

            <h3>Exploit</h3>
            <pre><code class="language-bash"># 1) Decompile APK
apktool d com.mcsc.couplegallery.apk -o couplegallery_apktool

# 2) Disassemble Hermes bundle (hbcdump from hermes-cli)
# hbcdump -pretty-disassemble -c "disassemble;quit" assets/index.android.bundle &gt; hbc_disasm.txt

# 3) Decrypt DB rows
NODE_PATH=/tmp/crypt/node_modules node -e "
const sqlite3=require('sqlite3').verbose();
const CryptoJS=require('crypto-js');
const fs=require('fs');

const db=new sqlite3.Database('couplegallery_apktool/res/raw/assets_gallery_secure.db');
const key='wh0_s3aid_r3act_n4t1v3';
const prefix='VALID_IMG_PREFIX';

db.all('select id, encrypted_data from images', (err, rows)=>{
  if (err) throw err;
  rows.forEach(r=>{
    const dec=CryptoJS.AES.decrypt(r.encrypted_data, key).toString(CryptoJS.enc.Utf8);
    if (!dec.startsWith(prefix)) return;
    const b64=dec.slice(prefix.length);
    fs.writeFileSync(`dec_${r.id}.png`, Buffer.from(b64,'base64'));
  });
  db.close();
});
"</code></pre>

            <h3>Result</h3>
            <p>How each flag part was found:</p>
            <h4>Part 1 (AES key)</h4>
            <ul>
              <li>Where: Hermes bytecode strings / env init in assets/index.android.bundle.</li>
              <li>Method: hbcdump disassembly, search string table for constants.</li>
              <li>Found wh0_s3aid_r3act_n4t1v3 assigned into the GalleryScreen env slot used by AES.decrypt.</li>
            </ul>

            <h4>Part 2 (image text)</h4>
            <ul>
              <li>Where: extracted PNG from DB.</li>
              <li>Method: decrypt rows, strip VALID_IMG_PREFIX, base64-decode to PNG.</li>
              <li>dec_5.png displays text: _1s_s3cure?_k3y_w4s_.</li>
            </ul>

            <h4>Part 3 (PIN)</h4>
            <ul>
              <li>Where: Hermes bytecode constants.</li>
              <li>Method: disassembly shows constant 369963 in keypad validation logic.</li>
              <li>Confirmed it is the only 6-digit constant used in PIN comparison.</li>
            </ul>

            <p>Final flag: esch{wh0_s3aid_r3act_n4t1v3_1s_s3cure?_k3y_w4s_369963}</p>

            <h3>Summary</h3>
            <p>
              The app's security fails because all secrets live client-side. Extracting the
              Hermes bundle revealed both the AES key and PIN; decrypting the bundled DB with
              the AES key recovered the images and flag text. The correct fix would be to avoid
              static client-side keys and move decryption to a trusted backend or device-bound
              secret.
            </p>
          </div>
        </section>

        <section class="writeup-nav">
          <a class="secondary" href="writeups.html">&larr; Back to writeups</a>
        </section>
      </main>

      <footer class="footer">
        <p>© <span id="year"></span> Axiom Vale. Built for GitHub Pages.</p>
      </footer>
    </div>
    <script>
      const year = document.getElementById("year");
      if (year) year.textContent = new Date().getFullYear();
    </script>
  </body>
</html>
